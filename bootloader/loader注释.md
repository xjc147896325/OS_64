Ptr 指针缩写

DESC 描述

前面不赘述，详见boot注释

10行~13行：
-
> 本系统的内核程序起始地址位于物理地址0x100000（ 1 MB）处，因为1 MB以下的物理地址并不
> 全是可用内存地址空间，这段物理地址被划分成若干个子空间段，它们可以是内存空间、非内存空间
> 以及地址空洞。随着内核体积的不断增长，未来的内核程序很可能会超过1 MB，因此让内核程序跳过
> 这些纷繁复杂的内存空间，从平坦的1 MB地址开始，这是一个非常不错的选择。
> 内存地址0x7E00是内核程序的临时转存空间，由于内核程序的读取操作是通过BIOS中断服务程
> 序INT 13h实现的， BIOS在实模式下只支持上限为1 MB的物理地址空间寻址，所以必须先将内核程序
> 读入到临时转存空间，然后再通过特殊方式搬运到1 MB以上的内存空间中。当内核程序被转存到最终
> 内存空间后，这个临时转存空间就可另作他用，此处将其改为内存结构数据的存储空间，供内核程序
> 在初始化时使用。本节将主要围绕上述内容逐步展开代码实现。

15行~39行：
-
32位的gdt和64位的gdt表，具体的数值意义没细究。

42行~98行：
-
**46~65：**不解释，见前。

**67~89：**重点对象。

在16位宽状态下
0x66为32位宽数据指令

0x67为32位宽地址指令

> 这段代码的起始部分开启地址A20功能，此项功能属于历史遗留问题。最初的处理器只有20根地
> 址线，这使得处理器只能寻址1MB以内的物理地址空间，如果超过1 MB范围的寻址操作，也只有低20
> 位是有效地址。随着处理器寻址能力的不断增强， 20根地址线已经无法满足今后的开发需求。为了保
> 证硬件平台的向下兼容性，便出现了一个控制开启或禁止1 MB以上地址空间的开关。当时的8042键盘
> 控制器上恰好有空闲的端口引脚（输出端口P2，引脚P21），从而使用此引脚作为功能控制开关，即A20
> 功能。如果A20引脚为低电平（数值0），那么只有低20位地址有效，其他位均为0。
> 在机器上电时，默认情况下A20地址线是被禁用的，所以操作系统必须采用适当的方法开启它。
> 由于硬件平台的兼容设备种类繁杂，进而出现多种开启A20功能的方法。
> 
> 本系统通过访问A20快速门来开启A20功能，即置位0x92端口的第1位。
> 
> 当A20功能开启后，紧接着使用指令CLI关闭外部中断，再通过指令LGDT加载保护模式结构数据
信息，并置位CR0寄存器的第0位来开启保护模式。当进入保护模式后，为FS段寄存器加载新的数据
段值，一旦完成数据加载就从保护模式中退出，并开启外部中断。整个动作一气呵成，实现了保护模
式的开启和关闭。看似多此一举的代码，其目的只是为了让FS段寄存器可以在实模式下寻址能力超过
1 MB，也就是传说中的Big Real Mode模式，详细的原理级说明请参见第7章。通过此番操作后，借助
FS段寄存器的特殊寻址能力，就可将内核程序移动到1 MB以上的内存地址空间中。

u1s1不是很懂

**93~95：**

复位软盘。借助BIOS 13h中断

**98：**

将扇区根目录写到地址SectorNo，与boot类似

100行~244行：
-
与boot一样，找到Kernel的位置，cld为复位DF，loadsb会把SI里的地址读出来给al，会自减或自加

**其196~234行为其逐字节复制：**

> 这部分程序负责将内核程序读取到临时转存空间中，随后再将其移动至1 MB以上的物理内存空
> 间。为了避免转存环节发生错误，还是一个字节一个字节的复制为妙，借助汇编指令LOOP可完成此
> 项工作。由于内核体积庞大必须逐个簇地读取和转存，那么每次转存内核程序片段时必须保存目标偏
> 移值，该值（ EDI寄存器）保存于临时变量OffsetOfKernelFileCount中

FAT12文件系统读到0xfffh就表示这个文件到头了

[FAT12介绍](https://blog.csdn.net/judyge/article/details/52373751)

246行~252行：
-
> 这段代码首先将GS段寄存器的基地址设置在0B800h地址处，并将AH寄存器赋值为0Fh，将AL
> 寄存器赋值为字母'G'，然后将AX寄存器的值填充到地址0B800h向后偏移(80× 0 + 39) × 2处。该方
> 法与BIOS的INT 10h中断服务程序相比，更符合操作显卡内存的习惯。从内存地址0B800h开始，是一
> 段专门用于显示字符的内存空间，每个字符占用两个字节的内存空间，其中低字节保存显示的字符，
> 高字节保存字符的颜色属性。此处的属性值0Fh表示字符使用白色字体、黑色背景。


<font color='red'>后续看书吧，反正打印硬件信息，从实模式跳转到保护模式再到64位模式。</font>